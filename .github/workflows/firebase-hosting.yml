name: Firebase Hosting Deploy

on:
  push:
    branches: [ prod, dev ]
  pull_request:
    branches: [ prod, dev ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check FIREBASE_TOKEN
        id: token
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          if [ -n "$FIREBASE_TOKEN" ]; then
            echo "HAS_TOKEN=true" >> $GITHUB_OUTPUT
          else
            echo "HAS_TOKEN=false" >> $GITHUB_OUTPUT
          fi

      - name: Set environment mapping
        id: envmap
        run: |
          if [[ "${GITHUB_REF_NAME}" == "prod" ]]; then
            echo "ALIAS=prod" >> $GITHUB_OUTPUT
            echo "ENVIRONMENT=Prod" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF_NAME}" == "dev" ]]; then
            echo "ALIAS=dev" >> $GITHUB_OUTPUT
            echo "ENVIRONMENT=Dev" >> $GITHUB_OUTPUT
          else
            echo "ALIAS=dev" >> $GITHUB_OUTPUT
            echo "ENVIRONMENT=Dev" >> $GITHUB_OUTPUT
          fi

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install deps
        if: hashFiles('package.json') != ''
        run: |
          npm ci

      - name: Build
        if: hashFiles('package.json') != ''
        env:
          NODE_ENV: production
        run: |
          if npm run | grep -qE "\bbuild\b"; then
            npm run build
          else
            echo "No build script; skipping build"
          fi

      - name: Install Firebase CLI
        run: npm i -g firebase-tools

      - name: Deploy to Firebase Hosting (push)
        if: github.event_name == 'push' && steps.token.outputs.HAS_TOKEN == 'true'
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          firebase deploy --only hosting --project ${{ steps.envmap.outputs.ALIAS }}

      - name: Preview deploy to Hosting (PR)
        if: github.event_name == 'pull_request' && steps.token.outputs.HAS_TOKEN == 'true'
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          firebase hosting:channel:deploy ${{ github.head_ref }} \
            --project ${{ steps.envmap.outputs.ALIAS }} \
            --expires 7d
